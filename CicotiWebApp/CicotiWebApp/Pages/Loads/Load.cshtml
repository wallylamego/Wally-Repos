@page  "{id?}"
@model CicotiWebApp.Pages.Loads.LoadModel

@{
    ViewData["Title"] = "Create";
    Layout = "~/Pages/_LayoutDataTables.cshtml";
}
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Xsrf
@functions{
    public string GetAntiXsrfRequestToken()
    {
        return Xsrf.GetAndStoreTokens(Model.HttpContext).RequestToken;
    }
}

<h4>Load</h4>
<hr />
<div id="accordion">
    <div class="card" id="cardSection1">
        <div class="card-header" id="headingOne">
            <h5 class="mb-0">
                <button class="btn-primary" data-toggle="collapse" data-target="#collapseOne" aria-expanded="true"
                        aria-controls="collapseOne" style="background-color:darkred; border:outset; font-size:medium; border-color:white">
                    Section 1: Load Number,  LoadName,  LoadDate, Driver
                </button>
            </h5>
        </div>
        <div id="collapseOne" class="collapse" aria-labelledby="headingOne" data-parent="#accordion">
            <div class="row" id="divLoadHeaderForm">
                <div class="col-md-4">
                    <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                    <input type="hidden" asp-for="Load.LoadID" id="loadID" />
                    <input type="hidden" asp-for="Load.VehicleID" id="vehicleID" />
                    <input type="hidden" asp-for="Load.DriverID" id="driverID" />
                    <div class="form-group" id="divLoadName">
                        <label class="control-label">Load Name</label>
                        <input asp-for="Load.LoadName" id="tripCode" class="form-control" />
                        <span asp-validation-for="Load.LoadName" class="text-danger"></span>
                    </div>
                    <div class="form-group" id="divCreatedBy">
                        <label id="createdByLabel" class="control-label">Created By</label>
                        <input asp-for="Load.User.UserName" id="createdBy" class="form-control" />
                    </div>
                    <div class="form-group" id="divCreatedDate">
                        <label id="createdDateLabel" class="control-label">Create Date</label>
                        <input asp-for="Load.CreatedUtc" id="createdDate" class="form-control" />
                    </div>
                    <div id="DriverSection">
                        <div class="input-group" id="divDriverBtns">
                            <span class="input-group-btn">
                                <input type="button" value="Find Driver." class="btn btn-default" id="findDriverBtn" />
                            </span>
                            <span class="input-group-btn">
                                <input type="button" value="Show Driver." class="btn btn-default" id="showDriverBtn" />
                            </span>
                        </div>
                        <br />
                        <div id="divDriverInputFieldsSection" class="well-sm" style="background-color:lightgray">
                            <div class="form-group" id="divDriverFirstName">
                                <label class="control-label">Driver First Name</label>
                                <input asp-for="Load.Driver.FirstName" id="driverFirstName" class="form-control" />
                                <span asp-validation-for="Load.Driver.FirstName" class="text-danger"></span>
                            </div>
                            <div class="form-group" id="divDriverSecondName">
                                <label class="control-label">Driver Surname</label>
                                <input asp-for="Load.Driver.Surname" id="driverSurname" class="form-control" />
                                <span asp-validation-for="Load.Driver.Surname" class="text-danger"></span>
                            </div>
                            <div class="form-group" id="divDriverCellNumber">
                                <label class="control-label">Driver Cell Number</label>
                                <input asp-for="Load.Driver.CellNumber" id="driverCellNumber" class="form-control" />
                                <span asp-validation-for="Load.Driver.CellNumber" class="text-danger"></span>
                            </div>
                        </div>
                        <div id="divDriverTable" style="width:90%; margin:0 auto;">
                            <table id="DriverTable" class="table table-striped table-bordered dt-responsive nowrap" width="100%" cellspacing="0">
                                <thead>
                                    <tr>
                                        <th>DriverID</th>
                                        <th>First Name</th>
                                        <th>Surname</th>
                                        <th>Cell Number</th>
                                        <th>Select</th>
                                    </tr>
                                </thead>
                            </table>
                        </div>
                    </div>
                    <div id="VehicleSection">
                        <div class="input-group" id="divVehicleBtns">
                            <span class="input-group-btn">
                                <input type="button" value="Find Vehicle." class="btn btn-default" id="findVehicleBtn" />
                            </span>
                            <span class="input-group-btn">
                                <input type="button" value="Show Vehicle." class="btn btn-default" id="showVehicleBtn" />
                            </span>
                        </div>
                        <br />
                        <div id="divVehicleInputFieldsSection" class="well-sm" style="background-color:lightgray">
                            <div class="form-group" id="divSubContractor">
                                <label class="control-label">SubContractpr</label>
                                <input asp-for="Load.Vehicle.SubContractor.Name" id="subContractor" class="form-control" />
                                <span asp-validation-for="Load.Vehicle.SubContractor.Name" class="text-danger"></span>
                            </div>
                            <div class="form-group" id="divVehicleRegistrationNo">
                                <label class="control-label">Vehicle Registration</label>
                                <input asp-for="Load.Vehicle.RegistrationNumber" id="registrationNumber" class="form-control" />
                                <span asp-validation-for="Load.Vehicle.RegistrationNumber" class="text-danger"></span>
                            </div>
                            <div class="form-group" id="divVehicleType">
                                <label class="control-label">Vehicle Type</label>
                                <input asp-for="Load.Vehicle.VechileType.Description" id="vehicleType" class="form-control" />
                                <span asp-validation-for="Load.Vehicle.VechileType.Description" class="text-danger"></span>
                            </div>
                        </div>
                        <div id="divVehicleTable" style="width:90%; margin:0 auto;">
                            <table id="VehicleTable" class="table table-striped table-bordered dt-responsive nowrap" width="100%" cellspacing="0">
                                <thead>
                                    <tr>
                                        <th>VehicleID</th>
                                        <th>Registration Number</th>
                                        <th>Vehicle Type</th>
                                        <th>Sub Contractor</th>
                                        <th>Select</th>
                                    </tr>
                                </thead>
                            </table>
                        </div>
                    </div>
                    <br />
                    <div class="form-group">
                        <input type="button" value="Save" class="btn btn-default  " id="savebtnSection1" />
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>


<div>
    <a asp-page="Index">Back to List</a>
</div>

@section Scripts {
    <script type="text/javascript">

        function updateVehicleInputFields(data) {
            var selectedVehicle = {};
            selectedVehicle = JSON.parse(data);
            $("#vehicleID").val(selectedVehicle.vehicleID);
            $("#registrationNumber").val(decodeURIComponent(selectedVehicle.registrationNumber));
            $("#vehicleType").val(decodeURIComponent(selectedVehicle.vehicleType));
            $("#subContractor").val(decodeURIComponent(selectedVehicle.subContractor));


            $("#divVehicleInputFieldsSection").show();

            $("#divVehicleTable").hide();
            $('#showVehicleBtn').val("Hide Vechile");
        }
        
        function GetVehicleData(){
            $("#VehicleTable").on('xhr.dt', function (e, settings, json, xhr) {
            }).DataTable({
                lengthMenu: [25, 100, 150, 200],
                "fixedHeader": {
                    "header": true,
                    "footer": true
                },
                "responsive": true,
                "processing": true, // for show progress bar
                "serverSide": true, // for process server side
                "filter": true, // this is for disable filter (search box)
                "orderMulti": false, // for disable multiple column at once
                "ajax": {
                    
                    "url": "/Loads/Load?handler=VehiclePaging",
                     "headers":
                        {
                            "RequestVerificationToken": '@GetAntiXsrfRequestToken()'
                        },
                    "type": "POST",
                    /*"contentType": "application/x-www-form-urlencoded",*/
                    "datatype": "json"
                },
                "columnDefs":
                [   {
                        /*Vehicle ID is not visible and is not searchable*/
                        "targets": [0],
                        "visible": false,
                        "searchable": false
                    },
                    {
                        /*Registration Number is visible and is searchable*/
                        "targets": [1],
                        "visible": true,
                        "searchable": true
                    },
                    {
                        /*VehicleType is visible and is searchable*/
                        "targets": [2],
                        "visible": true,
                        "searchable": true
                    },
                    {
                        /*SubContractor is visible and is searchable*/
                        "targets": [3],
                        "visible": true,
                        "searchable": true
                    },
                    {
                        /*Select button  is  visible and is not searchable*/
                        "targets": [4],
                        "visible": true,
                        "searchable": false,
                        "orderable": false
                    },
                ],
                "columns": [
                    { "data": "vehicleID", "name": "vehicleID", "autoWidth": true },
                    { "data": "registrationNumber", "name": "registrationNumber", "autoWidth": true },
                    { "data": "vehicleType", "name": "vehicleType", "autoWidth": true },
                    { "data": "subContractor", "name": "subContractor", "autoWidth": true },
                    {
                        "render": function (data, type, full, meta) {
                            var selectedVehicle = {};
                            selectedVehicle.vehicleID = full.vehicleID;
                            selectedVehicle.registrationNumber = encodeURIComponent(full.registrationNumber);
                            selectedVehicle.vehicleType = encodeURIComponent(full.vehicleType);
                            selectedVehicle.subContractor = encodeURIComponent(full.subContractor);
                            return "<p data-placement='top' data-toggle='tooltip' title='Select'><button id='btnDriver' class='btn btn-primary btn-xs' data-title='Select' data-toggle='modal' data-target='#edit' onclick=updateVehicleInputFields('" + JSON.stringify(selectedVehicle) + "')><span class='glyphicon glyphicon-pencil'></span></button></p>";
                        }
                    }
                    ]
            });//End Ajax Call
        }//Function GetVehicleData

        function updateDriverInputFields(data) {
            var selectedDriver = {};
            selectedDriver = JSON.parse(data);
            $("#driverID").val(selectedDriver.driverID);
            $("#driverFirstName").val(decodeURIComponent(selectedDriver.firstName));
            $("#driverSurname").val(decodeURIComponent(selectedDriver.surname));
            $("#driverCellNumber").val(decodeURIComponent(selectedDriver.cellNumber));


            $("#divDriverInputFieldsSection").show();

            $("#divDriverTable").hide();
            $('#showDriverBtn').val("Hide Driver");
        }


        function GetDriverData() {
            $("#DriverTable").on('xhr.dt', function (e, settings, json, xhr) {
            }).DataTable({
                lengthMenu: [25, 100, 150, 200],
                "fixedHeader": {
                    "header": true,
                    "footer": true
                },
                "responsive": true,
                "processing": true, // for show progress bar
                "serverSide": true, // for process server side
                "filter": true, // this is for disable filter (search box)
                "orderMulti": false, // for disable multiple column at once
                "ajax": {

                    "url": "/Loads/Load?handler=DriverPaging",
                     "headers":
                        {
                            "RequestVerificationToken": '@GetAntiXsrfRequestToken()'
                        },
                    "type": "POST",
                    /*"contentType": "application/x-www-form-urlencoded",*/
                    "datatype": "json"
                },
                "columnDefs":
                [{
                        /*Driver ID is not visible and is not searchable*/
                        "targets": [0],
                        "visible": false,
                        "searchable": false
                    },
                    {
                        /*FirstName is visible and is not searchable*/
                        "targets": [1],
                        "visible": true,
                        "searchable": true
                    },
                    {
                        /*Surname is  visible and is  searchable*/
                        "targets": [2],
                        "visible": true,
                        "searchable": true
                    },
                    {
                        /*Cell Number  is  visible and is  searchable*/
                        "targets": [3],
                        "visible": true,
                        "searchable": true
                    },
                    {
                        /*Select button  is  visible and is not searchable*/
                        "targets": [4],
                        "visible": true,
                        "searchable": false,
                        "orderable": false
                    }
                ],
                "columns": [
                    { "data": "driverID", "name": "driverID", "autoWidth": true },
                    { "data": "firstName", "name": "firstName", "autoWidth": true },
                    { "data": "surname", "name": "surname", "autoWidth": true },
                    { "data": "cellNumber", "name": "cellNumber", "autoWidth": true },
                    {
                        "render": function (data, type, full, meta) {
                            var selectedDriver = {};
                            selectedDriver.driverID = full.driverID;
                            selectedDriver.firstName = encodeURIComponent(full.firstName);
                            selectedDriver.surname = encodeURIComponent(full.surname);
                            selectedDriver.cellNumber = encodeURIComponent(full.cellNumber);
                            return "<p data-placement='top' data-toggle='tooltip' title='Select'><button id='btnDriver' class='btn btn-primary btn-xs' data-title='Select' data-toggle='modal' data-target='#edit' onclick=updateDriverInputFields('" + JSON.stringify(selectedDriver) + "')><span class='glyphicon glyphicon-pencil'></span></button></p>";
                        }
                    }
                ]

            });//Drivers Table
        }//getVehicleData
        $(document).ready(function ()
        {
            //hide the driver table and the driver capture fields when the form starts up
            $("#divDriverTable").hide();
            $("#divDriverInputFieldsSection").hide();
            $("#driverFirstName").prop("disabled", true);
            $("#driverSurname").prop("disabled", true);
            $("#driverCellNumber").prop("disabled", true);

            //hide the vehicle table and the vehicle capture fields when the form starts up
            $("#divVehicleTable").hide();
            $("#divVehicleInputFieldsSection").hide();
            $("#registrationNumber").prop("disabled", true);
            $("#vehicleType").prop("disabled", true);
            $("#subContractor").prop("disabled", true);


            //Find Driver
            $('#findDriverBtn').click(function () {
                $("#divDriverTable").show();
                $('#divDriverInputFieldsSection').hide();
                if (!$.fn.DataTable.isDataTable('#DriverTable')) {
                    GetDriverData();
                }
            });
            //Show and Hide Driver Button
            $('#showDriverBtn').click(function () {
                if ($('#showDriverBtn').val() == "Show Driver") {
                    $("#divDriverTable").hide();
                    $('#divDriverInputFieldsSection').show();
                    $('#showDriverBtn').val("Hide Driver");
                }
                else {
                    $("#divDriverTable").hide();
                    $('#divDriverInputFieldsSection').hide();
                    $('#showDriverBtn').val("Show Driver");
                }
            });
            //Find Vehicle
            $('#findVehicleBtn').click(function () {
                $("#divVehicleTable").show();
                $('#divVehicleInputFieldsSection').hide();
                if (!$.fn.DataTable.isDataTable('#VehicleTable')) {
                    GetVehicleData();
                }
            });
            //Show and Hide Vehicle Button
            $('#showVehicleBtn').click(function () {
                if ($('#showVehicleBtn').val() == "Show Vehicle") {
                    $("#divVehicleTable").hide();
                    $('#divVehicleInputFieldsSection').show();
                    $('#showVehicleBtn').val("Hide Vehicle");
                }
                else {
                    $("#divVehicleTable").hide();
                    $('#divVehicleInputFieldsSection').hide();
                    $('#showVehicleBtn').val("Show Vehicle");
                }
            });
        });//Document Ready end.

    </script>
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}
