@page
@{
    Layout = "_LayoutDataTables";
}
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Xsrf
@functions{
    public string GetAntiXsrfRequestToken()
    {
        return Xsrf.GetAndStoreTokens(Model.HttpContext).RequestToken;
    }
}
@model CicotiWebApp.Pages.Invoice.IndexModel

@{
    ViewData["Title"] = "Index";
    Layout = "~/Pages/_LayoutDataTables.cshtml";
}

<h2>Invoice Listing</h2>

<div>
    <form id="InvForm" method="post"></form>
    <div class="form-group">
        <label asp-for="Status" class="control-label"></label>
        <select asp-for="Status.StatusID"
                asp-items="Model.StatusSL" class="form-control">
            Invoice Status
            <option value="">--Select Status--</option>
        </select>
        <span asp-validation-for="Status.StatusID" class="text-danger"></span>
    </div>
    <div class="form-group">
        <input type="submit" value="Update" class="btn btn-default" id="update"/>
    </div>
</div>
    <div id="divInvoiceTable" style="width:90%; margin:0 auto;">
        <table id="InvoiceTable" class="table table-striped table-bordered dt-responsive nowrap" width="100%" cellspacing="0">
            <thead>
                <tr>
                    <th>InvoiceID</th>
                    <th>Invoice Number</th>
                    <th>Invoice Printed Date</th>
                    <th>Invoice Status</th>
                    <th>Update</th>
                </tr>
            </thead>
        </table>
    </div>

    @await Html.PartialAsync("_ModalPartial")

    @section Scripts {

        <script type="text/javascript">
           
        $(document).ready(function ()
        {
            $('#update').click(function () {
                alert("Button Pressed");
                var arrInv = [];
                var InvItem = new Object();
                
                $('input[type="checkbox"]').each(function () {
                    //if checkbox is checked
                    if (this.checked) {
                        console.log("InvoiceID:" + this.value);
                        InvItem = new Object();
                        InvItem.invoiceID = this.value;
                        arrInv.push(InvItem);
                        //create hidden element
                        //$(form).append(
                        //    $('<input>')
                        //        .attr('type', 'hidden')
                        //        .attr('name', this.name)
                        //        .val(this.value)
                        //);
                    }
                });
                for (var i = 0; i < arrInv.length; i++) {
                    console.log("Item in Array: " + i);
                    console.log(arrInv[i].invoiceID);
                }
                ajaxInvoiceUpdate(arrInv);
            });

            $("#InvoiceTable").on('xhr.dt', function (e, settings, json, xhr) {
            }).DataTable({
                lengthMenu: [25, 100, 150, 200],
                dom: '<lfB<t>ip>',
                buttons: ['excel', 'copy', 'csv', 'pdf', 'print'],
                "fixedHeader": {
                    "header": true,
                    "footer": true
                },
                "responsive": true,
                "processing": true, // for show progress bar
                "serverSide": true, // for process server side
                "filter": true, // this is for disable filter (search box)
                "orderMulti": false, // for disable multiple column at once
                "ajax": {

                    "url": "/Invoice/Index?handler=Paging",
                     "headers":
                        {
                            "RequestVerificationToken": '@GetAntiXsrfRequestToken()'
                        },
                    "type": "POST",
                    /*"contentType": "application/x-www-form-urlencoded",*/
                    "datatype": "json"
                },
                "columnDefs":
                [   {
                        /*Invoice ID is not visible and is not searchable*/
                        "targets": [0],
                        "visible": false,
                        "searchable": false
                    },
                    {
                        /*Invoice Number is visible and is  searchable*/
                        "targets": [1],
                        "visible": true,
                        "searchable": true
                    },
                    {
                        /*Invoice Printed Date No is visible and is searchable*/
                        "targets": [2],
                        "visible": true,
                        "searchable": true
                        },
                    {
                        /*Status is visible and is searchable*/
                        "targets": [3],
                        "visible": true,
                        "searchable": true
                    }

                ],
                "columns": [
                    { "data": "invoiceID", "name": "invoiceID", "autoWidth": true },
                    { "data": "invoiceNumber", "name": "invoiceNumber", "autoWidth": true },
                    { "data": "invoicePrintDate", "name": "invoicePrintDate", "autoWidth": true },
                    { "data": "statusName", "name": "statusName", "autoWidth": true },
                    {
                        'render': function (data, type, full, meta) {
                            return '<input type="checkbox" name="id[]" value="'
                                + $('<div/>').text(full.invoiceID).html() + '">';
                        }
                    }
                ]

            });//Invoice Table
        });//Document Ready end.
        function ajaxInvoiceUpdate(obj) {
            console.log("Update Invoice Status: in Insert Ajax Call: " + JSON.stringify(obj));
            $.ajax({
                type: "POST",
                url: "/Invoice/Index?handler=Update",
                    headers:
                        {
                            "RequestVerificationToken": '@GetAntiXsrfRequestToken()'
                        },
                    contentType: "application/json",
                    dataType: "json",
                    data: JSON.stringify(obj),
                    success: function (data) {
                        console.log(data);
                       // $("#tripId").val(data.tripID);
                      //  $("#createdBy").val(data.user.userName);
                      //  $("#createdBy").show();
                      //  $("#createdByLabel").show();

                      //  $("#createdDate").val(moment(data.createdUtc).format("YYYY-MM-DDTHH:mm"));
                      //  $("#createdDate").show();
                     //   $("#createdDateLabel").show();
                        //format: "YYYY/MM/DD hh:mm:ss A",
                      //  console.log("Hidden Trip Id:" + $("#tripId").val());
                       
                        $("#modalHeader").text("Invoice Status Processing Status");
                     //   $("#modalMessage").text(data.tripID + " was inserted.");
                        $("#modalMessage").text(" Invoice Status was inserted.");
                        $("#myModal").modal("show");
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        $("#modalHeader").text("Invoice Status Processing Status");
                        $("#modalMessage").text("Invoice Status Not Processed Not Updated.");
                        $("#myModal").modal("show");
                    }
                });//ajax update
        }


        </script>
    }
